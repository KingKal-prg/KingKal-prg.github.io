<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Chatbot with Image Upload</title>
  <style>
    /* CSS - Keeping your original CSS for styling */
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      margin: 0;
      padding: 20px;
      color: #f1f1f1;
    }

    h1 {
      text-align: center;
      color: #f1f1f1;
    }

    #chat {
      background: #2a2a2a;
      padding: 20px;
      border: 1px solid #444;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      /* Ensure chat content stacks vertically */
    }

    #messages {
      list-style: none;
      padding: 0;
      max-height: 400px;
      /* Or adjust height as needed */
      overflow-y: auto;
      margin-bottom: 20px;
      flex-grow: 1;
      /* Allow messages area to grow */
    }

    #messages li {
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
      word-wrap: break-word;
      /* Prevent long words/URLs from overflowing */
    }

    #input {
      display: flex;
      align-items: center;
      margin-top: auto;
      /* Push input to the bottom */
    }

    #input input[type="text"] {
      flex: 1;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #555;
      border-radius: 5px;
      background: #333;
      color: #f1f1f1;
    }

    /* Style for Send and Upload buttons */
    .action-button {
      padding: 10px 20px;
      border: none;
      background-color: #007bff;
      color: #f1f1f1;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 5px;
      /* Spacing between buttons */
    }

    .action-button:hover {
      background-color: #0056b3;
    }

    .action-button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    /* Hide the actual file input */
    #imageInput {
      display: none;
    }

    /* Image Preview Area */
    #imagePreviewContainer {
        margin-top: 10px;
        text-align: center; /* Center the preview */
    }

    #imagePreview {
        max-width: 100px; /* Limit preview size */
        max-height: 100px;
        margin-top: 5px;
        border: 1px solid #555;
        border-radius: 5px;
        display: none; /* Hide initially */
    }
     #imageFileName {
        font-size: 0.9em;
        color: #aaa;
        margin-top: 5px;
        display: block; /* Ensure it takes its own line */
     }


    /* Spinner Styles (unchanged) */
    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 1000;
    }

    .spinner {
      border: 16px solid #333;
      border-top: 16px solid #007bff;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div id="chatInterface">
    <h1>Simple Chatbot</h1>
    <div id="chat">
      <ul id="messages"></ul>
       <div id="imagePreviewContainer">
           <span id="imageFileName">No image selected</span>
           <img id="imagePreview" src="#" alt="Image preview"/>
       </div>
      <div id="input">
        <input type="text" id="userInput" placeholder="Type your message here..." />
        <input type="file" id="imageInput" accept="image/png, image/jpeg, image/gif, image/webp">
        <button id="uploadButton" class="action-button">Upload Image</button>
        <button id="send" class="action-button">Send</button>
      </div>
    </div>
  </div>

  <div id="spinner-container" class="spinner-container">
    <div class="spinner"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const messages = document.getElementById('messages');
      const userInput = document.getElementById('userInput');
      const sendButton = document.getElementById('send');
      const uploadButton = document.getElementById('uploadButton');
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const imageFileName = document.getElementById('imageFileName');
      const spinnerContainer = document.getElementById('spinner-container');

      // --- API Keys (VERY INSECURE - Use a backend in production!) ---
      const openAIApiKey = "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"; // Replace YOUR_API_KEY if needed, but revoke this one ASAP.
      const deepSeekApiKey = "sk-87fa4efb1c6c483f9e96f9942a88fdb6"; // Your DeepSeek Key (currently unused in this example but available)
      // --- End API Keys ---

      let teachings = JSON.parse(localStorage.getItem('teachings')) || {};
      let selectedImageBase64 = null; // To store the selected image data
      let selectedFileName = null; // To store the selected image filename

      // Function to display messages
      function displayMessage(sender, message, imageUrl = null) {
        const li = document.createElement('li');
        li.textContent = `${sender}: ${message}`;
        if (imageUrl) {
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.maxWidth = '150px'; // Display smaller image in chat
            img.style.display = 'block';
            img.style.marginTop = '5px';
            li.appendChild(img);
        }
        messages.appendChild(li);
        messages.scrollTop = messages.scrollHeight;
      }

      // Function to check local storage for an answer (Text only)
      function checkLocalStorage(query) {
        query = query.toLowerCase();
        if (teachings[query]) {
          return teachings[query];
        }
        return null;
      }

      // --- OpenAI API Call Functions ---

      // Function to call standard ChatGPT (Text only)
      async function callChatGPTText(query) {
        const apiUrl = "https://api.openai.com/v1/chat/completions";
        spinnerContainer.style.display = 'flex'; // Show spinner

        const payload = {
          model: "gpt-3.5-turbo", // Standard text model
          messages: [{ role: "user", content: query }]
        };

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + openAIApiKey
            },
            body: JSON.stringify(payload)
          });

          const data = await response.json();
          spinnerContainer.style.display = 'none'; // Hide spinner

          if (response.ok && data.choices && data.choices.length > 0) {
            return data.choices[0].message.content.trim();
          } else {
             console.error("ChatGPT Text API Error:", data);
             // Basic Fallback attempt (Optional - could add Deepseek here)
             // if (!response.ok && deepSeekApiKey) {
             //    console.log("Trying DeepSeek as fallback...");
             //    // return await callDeepSeekAPI(query); // Need to implement callDeepSeekAPI
             // }
             return `Sorry, I couldn't get a response. Error: ${data.error?.message || 'Unknown error'}`;
          }
        } catch (error) {
          spinnerContainer.style.display = 'none'; // Hide spinner
          console.error("ChatGPT Text API Call Error:", error);
          return "Sorry, I encountered an error while trying to get an answer.";
        }
      }

      // Function to call ChatGPT Vision API (Text + Image)
      async function callChatGPTVision(textQuery, imageBase64) {
          // Use gpt-4-turbo as it includes vision capabilities and is generally recommended
          // gpt-4-vision-preview is an older alias you might see in examples.
          const model = "gpt-4-turbo";
          const apiUrl = "https://api.openai.com/v1/chat/completions";
          spinnerContainer.style.display = 'flex';

          const payload = {
              model: model,
              messages: [
                  {
                      role: "user",
                      content: [
                          { type: "text", text: textQuery || "Describe this image." }, // Include text query or a default
                          {
                              type: "image_url",
                              image_url: {
                                  "url": imageBase64 // Pass the base64 data URI directly
                                  // Optional: "detail": "low" or "high" can be added here
                              }
                          }
                      ]
                  }
              ],
              max_tokens: 300 // Adjust token limit as needed for vision responses
          };

          try {
              const response = await fetch(apiUrl, {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "Authorization": "Bearer " + openAIApiKey
                  },
                  body: JSON.stringify(payload)
              });

              const data = await response.json();
              spinnerContainer.style.display = 'none';

             if (response.ok && data.choices && data.choices.length > 0) {
                  return data.choices[0].message.content.trim();
              } else {
                  console.error("ChatGPT Vision API Error:", data);
                   // Optional: Add DeepSeek Vision API call here if available and needed
                  return `Sorry, I couldn't get a response from the vision model. Error: ${data.error?.message || 'Unknown error'}`;
              }
          } catch (error) {
              spinnerContainer.style.display = 'none';
              console.error("ChatGPT Vision API Call Error:", error);
              return "Sorry, I encountered an error processing the image.";
          }
      }


      // --- Event Listeners ---

      // Trigger hidden file input when upload button is clicked
      uploadButton.addEventListener('click', () => {
        imageInput.click();
      });

      // Handle file selection
      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();

          reader.onloadend = function() {
            selectedImageBase64 = reader.result; // Store base64 string
            selectedFileName = file.name;
            imagePreview.src = selectedImageBase64;
            imagePreview.style.display = 'block'; // Show preview
            imageFileName.textContent = `Selected: ${file.name}`; // Show filename
          }
          reader.readAsDataURL(file); // Read file as Data URL (base64)
        } else if (file) {
           // Reset if the selected file is not an image
           alert("Please select a valid image file (png, jpg, gif, webp).");
           resetImageSelection();
           imageInput.value = ''; // Clear the file input
        } else {
            // If no file selected (e.g., user cancelled)
            resetImageSelection();
        }
      });

      // Reset image selection state
      function resetImageSelection() {
          selectedImageBase64 = null;
          selectedFileName = null;
          imagePreview.style.display = 'none';
          imagePreview.src = '#';
          imageFileName.textContent = 'No image selected';
          imageInput.value = ''; // Important to allow re-selecting the same file
      }

      // Main function to handle sending messages (handles both text and image)
      async function sendMessage() {
        const textQuery = userInput.value.trim();
        const imageToSend = selectedImageBase64; // Get the currently selected image
        const imageFileNameToSend = selectedFileName;

        // Only proceed if there's text OR an image
        if (textQuery || imageToSend) {
            let userMessage = textQuery;
            if (imageToSend) {
                userMessage += ` (Image: ${imageFileNameToSend || 'Uploaded Image'})`;
            }

            displayMessage("User", textQuery, imageToSend); // Display text and preview of sent image
            userInput.value = ""; // Clear text input
            resetImageSelection(); // Clear image selection after sending

            // --- Logic to decide which API to call ---
            if (imageToSend) {
                // If there's an image, always use the Vision API
                const visionResponse = await callChatGPTVision(textQuery, imageToSend);
                displayMessage("Chatbot", visionResponse);
                // NOTE: We are NOT storing image-based Q&A in local storage for this example.
            } else {
                // If only text, use the original text logic (check local storage first)
                const queryLower = textQuery.toLowerCase();
                let answer = checkLocalStorage(queryLower);

                if (answer) {
                    displayMessage("Chatbot", answer);
                } else {
                    const gptResponse = await callChatGPTText(textQuery);
                    displayMessage("Chatbot", gptResponse);

                    // Store the new text-only question-answer pair if response is valid
                    if (!gptResponse.startsWith("Sorry,")) { // Avoid storing error messages
                        teachings[queryLower] = gptResponse;
                        localStorage.setItem('teachings', JSON.stringify(teachings));
                    }
                }
            }
        }
      }

      // Send button click
      sendButton.addEventListener('click', sendMessage);

      // Enter key in text input
      userInput.addEventListener('keydown', (event) => {
        if (event.key === "Enter") {
          sendMessage();
        }
      });
    });
  </script>
</body>

</html>
